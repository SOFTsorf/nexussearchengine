<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spotify Clone Ultimate</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

        :root {
            --spotify-green: #1ed760;
            --bg-base: #121212;
            --bg-elevated: #242424;
            --bg-highlight: #2a2a2a;
            --text-base: #ffffff;
            --text-subdued: #a7a7a7;
            --nav-bg: rgba(0,0,0,0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'Montserrat', -apple-system, sans-serif;
            background-color: var(--bg-base);
            color: var(--text-base);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ICONS --- */
        svg { fill: currentColor; }

        /* --- NAVIGATION BOTTOM --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 65px;
            background: var(--nav-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-subdued);
            font-size: 10px;
            cursor: pointer;
            width: 25%;
            padding-top: 5px;
        }
        .nav-item.active { color: var(--text-base); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* --- VIEWS --- */
        .view {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-top: 50px;
            padding-bottom: 150px;
            display: none;
        }
        .view.active { display: block; }
        .view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .view-header h1 { font-size: 24px; font-weight: 700; margin: 0; }
        .header-icons { display: flex; gap: 20px; }
        .header-icons svg { width: 24px; height: 24px; }

        /* --- FILTER PILLS --- */
        .filter-scroll { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 20px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-pill {
            background: #2a2a2a; color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 13px; font-weight: 500; white-space: nowrap; cursor: pointer;
        }
        .filter-pill.active { background: var(--spotify-green); color: black; }

        /* --- START GRID (Screenshot 3) --- */
        .start-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 30px;
        }
        .start-grid-item {
            background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center;
            overflow: hidden; cursor: pointer;
        }
        .start-grid-item img { width: 56px; height: 56px; object-fit: cover; }
        .start-grid-item span { padding: 0 10px; font-size: 13px; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- LISTS (Library & Podcasts) --- */
        .list-container { display: flex; flex-direction: column; gap: 16px; }
        .list-item { display: flex; align-items: center; cursor: pointer; }
        .list-item img { width: 64px; height: 64px; object-fit: cover; margin-right: 12px; }
        .list-item img.round { border-radius: 50%; }
        .list-item img.square { border-radius: 4px; }
        .list-info { flex: 1; overflow: hidden; }
        .list-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-base); }
        .list-title.green { color: var(--spotify-green); }
        .list-subtitle { display: flex; align-items: center; font-size: 13px; color: var(--text-subdued); margin-top: 4px; gap: 4px; }
        .pin-icon { color: var(--spotify-green); width: 12px; height: 12px; transform: rotate(45deg); }

        /* --- SEARCH --- */
        .search-box {
            background: #fff; border-radius: 4px; display: flex; align-items: center; padding: 10px 15px; margin-bottom: 20px;
        }
        .search-box input { border: none; outline: none; flex: 1; font-size: 16px; font-weight: 600; color: #000; margin-left: 10px; }

        /* --- PLUS MENU OVERLAY (Screenshot 5) --- */
        .overlay-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay-bg.active { display: block; opacity: 1; }
        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%; background: #242424;
            border-radius: 20px 20px 0 0; z-index: 101; padding: 20px; transition: bottom 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .bottom-sheet.active { bottom: 0; }
        .bs-item { display: flex; align-items: center; padding: 15px 0; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .bs-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .bs-icon svg { width: 24px; height: 24px; fill: var(--text-subdued); }
        .bs-text { display: flex; flex-direction: column; }
        .bs-text strong { font-size: 16px; margin-bottom: 4px; }
        .bs-text span { font-size: 13px; color: var(--text-subdued); }

        /* --- MINI PLAYER --- */
        .mini-player {
            position: fixed; bottom: 70px; left: 8px; right: 8px; height: 56px;
            background: #404040; border-radius: 6px; display: none; align-items: center;
            padding: 8px; z-index: 60; box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: pointer;
        }
        .mini-player img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .mini-info { flex: 1; margin: 0 10px; overflow: hidden; }
        .mini-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-artist { font-size: 12px; color: var(--text-subdued); }
        .mini-controls { display: flex; align-items: center; gap: 15px; padding-right: 10px; }
        .mini-controls svg { width: 24px; height: 24px; fill: white; }

        /* --- FULL SCREEN PLAYER (Screenshot 1) --- */
        .full-player {
            position: fixed; top: 100%; left: 0; width: 100%; height: 100%;
            background-color: #121212; z-index: 200; transition: top 0.3s ease-out;
            display: flex; flex-direction: column; padding: 20px; overflow: hidden;
        }
        .full-player.active { top: 0; }
        .fp-bg {
            position: absolute; top: -20%; left: -20%; width: 140%; height: 140%;
            background-size: cover; background-position: center; filter: blur(60px) brightness(0.4); z-index: -1;
        }
        .fp-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .fp-header svg { width: 24px; height: 24px; cursor: pointer; }
        .fp-header-text { text-align: center; font-size: 11px; letter-spacing: 1px; color: white; }
        .fp-header-text b { display: block; font-size: 13px; margin-top: 2px; }
        .fp-cover {
            width: 100%; aspect-ratio: 1/1; margin-top: 30px; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: cover; background: #000;
        }
        #yt-player-container { display: none; } /* Versteckt das YT Video, wir zeigen nur das Coverbild für echtes Spotify Feeling */

        .fp-track-info { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
        .fp-title { font-size: 24px; font-weight: 700; margin: 0; }
        .fp-artist { font-size: 16px; color: var(--text-subdued); margin: 5px 0 0 0; }
        .fp-check { width: 24px; height: 24px; fill: var(--spotify-green); }

        .fp-slider {
            -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2);
            border-radius: 2px; outline: none; margin-top: 25px;
        }
        .fp-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; cursor: pointer; }
        .fp-time { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-subdued); margin-top: 8px; font-variant-numeric: tabular-nums; }

        .fp-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .fp-controls svg { fill: white; width: 28px; height: 28px; cursor: pointer; }
        .play-pause-btn { width: 64px; height: 64px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .play-pause-btn svg { fill: black; width: 32px; height: 32px; }

        .fp-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: auto; margin-bottom: 20px; font-size: 12px; font-weight: 600; color: var(--text-subdued);}
    </style>
</head>
<body>

    <audio id="native-audio"></audio>
    <div id="yt-player-container"></div>

    <div id="view-start" class="view active">
        <div class="view-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:32px; height:32px; background:#e0e0e0; border-radius:50%; display:flex; justify-content:center; align-items:center; color:black; font-weight:bold;">P</div>
                <div class="filter-scroll" style="margin:0;">
                    <div class="filter-pill active">Alle</div>
                    <div class="filter-pill">Musik</div>
                    <div class="filter-pill">Podcasts</div>
                    <div class="filter-pill">Hörbücher</div>
                </div>
            </div>
        </div>

        <div class="start-grid" id="start-grid">
            </div>

        <h2 style="font-size:18px; margin-bottom:15px;">Für dich empfohlen</h2>
        <div class="list-container" id="start-list">
            </div>
    </div>

    <div id="view-search" class="view">
        <div class="view-header"><h1>Suchen</h1></div>
        <div class="search-box">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="black"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="searchInput" placeholder="Podcasts oder Songs suchen..." onkeydown="handleSearch(event)">
        </div>
        <div id="search-spinner" style="display:none; text-align:center; color:var(--text-subdued);">Suche über iTunes & Local...</div>
        <div class="list-container" id="search-results"></div>
    </div>

    <div id="view-library" class="view">
        <div class="view-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:32px; height:32px; background:#e0e0e0; border-radius:50%; display:flex; justify-content:center; align-items:center; color:black; font-weight:bold;">P</div>
                <h1>Bibliothek</h1>
            </div>
            <div class="header-icons">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <svg viewBox="0 0 24 24" onclick="openPlusMenu()"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>

        <div class="filter-scroll">
            <div class="filter-pill">Playlists</div>
            <div class="filter-pill">Podcasts</div>
            <div class="filter-pill">Künstler*innen</div>
            <div class="filter-pill">Heruntergeladen</div>
        </div>

        <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:600; margin-bottom:15px; cursor:pointer;">
            <span>↑↓ Zuletzt</span>
            <svg viewBox="0 0 24 24" width="16" height="16"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
        </div>

        <div class="list-container" id="library-list"></div>
    </div>

    <div class="mini-player" id="miniPlayer" onclick="toggleFullScreenPlayer(true)">
        <img id="mini-img" src="">
        <div class="mini-info">
            <div class="mini-title" id="mini-title">Titel</div>
            <div class="mini-artist" id="mini-artist">Artist</div>
        </div>
        <div class="mini-controls">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
            <svg id="mini-play-btn" onclick="togglePlay(event)" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
    </div>

    <div class="full-player" id="fullPlayer">
        <div class="fp-bg" id="fp-bg"></div>
        <div class="fp-header">
            <svg onclick="toggleFullScreenPlayer(false)" viewBox="0 0 24 24"><path d="M15.957 2.793a1 1 0 010 1.414L8.164 12l7.793 7.793a1 1 0 11-1.414 1.414L5.336 12l9.207-9.207a1 1 0 011.414 0z" transform="rotate(-90 12 12)"/></svg>
            <div class="fp-header-text">WIEDERGABE AUS PLAYLIST<b id="fp-context">Chill-Mix 2025</b></div>
            <svg viewBox="0 0 24 24"><path d="M12 3a2 2 0 100 4 2 2 0 000-4zm0 7a2 2 0 100 4 2 2 0 000-4zm0 7a2 2 0 100 4 2 2 0 000-4z"/></svg>
        </div>
        
        <img class="fp-cover" id="fp-cover" src="">

        <div class="fp-track-info">
            <div>
                <h2 class="fp-title" id="fp-title">Anchor</h2>
                <p class="fp-artist" id="fp-artist">Alex Baker, Hanging Valleys</p>
            </div>
            <svg class="fp-check" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="currentColor"/><path d="M10 16l-4-4 1.41-1.41L10 13.17l6.59-6.59L18 8l-8 8z" fill="#000"/></svg>
        </div>

        <input type="range" class="fp-slider" id="fp-slider" value="0" min="0" max="100" onchange="seekAudio(this.value)">
        <div class="fp-time">
            <span id="fp-time-current">0:00</span>
            <span id="fp-time-total">0:00</span>
        </div>

        <div class="fp-controls">
            <svg viewBox="0 0 24 24" style="fill: var(--spotify-green)"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            <div class="play-pause-btn" onclick="togglePlay(event)">
                <svg id="fp-play-btn" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
            <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
        </div>

        <div class="fp-bottom">
            <span>[Q] Lossless</span>
            <div style="display:flex; gap:15px">
                <svg viewBox="0 0 24 24" width="20" height="20"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h12v2H4z"/></svg>
            </div>
        </div>
    </div>

    <div class="overlay-bg" id="overlayBg" onclick="closePlusMenu()"></div>
    <div class="bottom-sheet" id="plusMenu">
        <div class="bs-item" onclick="createNewPlaylist()">
            <div class="bs-icon">
                <svg viewBox="0 0 24 24"><path d="M15 4v12.5a3.5 3.5 0 11-2-3.17V6h6V4h-4zM4 6h8v2H4zm0 5h8v2H4zm0 5h5v2H4z"/></svg>
            </div>
            <div class="bs-text">
                <strong>Playlist</strong>
                <span>Erstelle eine Playlist mit Songs oder Folgen.</span>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('start', this)">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Start
        </div>
        <div class="nav-item" onclick="switchTab('search', this)">
            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            Suchen
        </div>
        <div class="nav-item" onclick="switchTab('library', this)">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12zM10 9h8v2h-8zm0 3h4v2h-4zm0-6h8v2h-8z"/></svg>
            Bibliothek
        </div>
        <div class="nav-item" onclick="openPlusMenu()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            Erstellen
        </div>
    </div>

<script>
    // --- DATEN & LOCAL STORAGE ---
    const defaultLibrary = [
        { id: "1", type: "playlist", title: "Chill-Mix 2025", creator: "Patrick", pinned: false, cover: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=200", isGrid: true },
        { id: "2", type: "playlist", title: "Lieblingssongs", creator: "Patrick", pinned: true, cover: "https://via.placeholder.com/200/404040/ffffff?text=%E2%99%A5", isGrid: true },
        { id: "3", type: "podcast", title: "Wissen mit Johnny", creator: "Johnny", pinned: true, cover: "https://via.placeholder.com/200/1ed760/000?text=Wissen", isGrid: false },
        { id: "4", type: "playlist", title: "JBL Bass Boosted", creator: "Spotify", pinned: false, cover: "https://images.unsplash.com/photo-1615826932727-81f964af4ea7?w=200", isGrid: true },
        // Echter YouTube Song als Beispiel
        { id: "4NRXx6U8ABQ", type: "song", title: "Blinding Lights", creator: "The Weeknd", cover: "https://img.youtube.com/vi/4NRXx6U8ABQ/hqdefault.jpg" }
    ];

    let library = JSON.parse(localStorage.getItem('ultimate_lib')) || defaultLibrary;
    let currentTrack = null;
    let isPlaying = false;
    let ytPlayerReady = false;
    let ytPlayer;
    let progressInterval;
    const audioEl = document.getElementById('native-audio');

    const playSVG = '<path d="M8 5v14l11-7z"/>';
    const pauseSVG = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';

    // --- YOUTUBE INIT ---
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('yt-player-container', {
            height: '0', width: '0', videoId: '4NRXx6U8ABQ',
            playerVars: { 'autoplay': 0, 'controls': 0 },
            events: {
                'onReady': () => { ytPlayerReady = true; },
                'onStateChange': onYTStateChange
            }
        });
    }

    function onYTStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            isPlaying = true; updatePlayIcons(pauseSVG); startProgress();
        } else if (event.data == YT.PlayerState.PAUSED) {
            isPlaying = false; updatePlayIcons(playSVG); clearInterval(progressInterval);
        }
    }

    // --- AUDIO INIT (iTunes Podcasts) ---
    audioEl.addEventListener('play', () => { isPlaying = true; updatePlayIcons(pauseSVG); startProgress(); });
    audioEl.addEventListener('pause', () => { isPlaying = false; updatePlayIcons(playSVG); clearInterval(progressInterval); });

    // --- RENDER VIEWS ---
    function renderApp() {
        // Startseite: Grid
        const gridEl = document.getElementById('start-grid');
        gridEl.innerHTML = '';
        library.filter(i => i.isGrid).slice(0, 6).forEach(item => {
            gridEl.innerHTML += `
                <div class="start-grid-item" onclick="playMock('${item.title}')">
                    <img src="${item.cover}"><span>${item.title}</span>
                </div>`;
        });

        // Bibliothek & Start Liste
        const libEl = document.getElementById('library-list');
        const startListEl = document.getElementById('start-list');
        libEl.innerHTML = ''; startListEl.innerHTML = '';

        library.forEach(item => {
            const html = `
                <div class="list-item" onclick="playItem('${item.id}')">
                    <img src="${item.cover}" class="${item.type === 'podcast' ? 'round' : 'square'}">
                    <div class="list-info">
                        <div class="list-title ${item.pinned ? 'green' : ''}">${item.title}</div>
                        <div class="list-subtitle">
                            ${item.pinned ? `<svg class="pin-icon" viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 2 1-2v-6h5v-2l-2-2z"/></svg>` : ''}
                            ${item.type === 'playlist' ? 'Playlist' : 'Podcast'} • ${item.creator}
                        </div>
                    </div>
                </div>`;
            libEl.innerHTML += html;
            if(!item.isGrid) startListEl.innerHTML += html; // Podcasts auch auf Start
        });
    }

    // --- LOGIK: SUCHEN & iTUNES API ---
    async function handleSearch(e) {
        if (e.key === 'Enter') {
            const q = document.getElementById('searchInput').value;
            if(!q) return;
            
            document.getElementById('search-spinner').style.display = 'block';
            const resEl = document.getElementById('search-results');
            resEl.innerHTML = '';

            try {
                // Echte iTunes Podcast Suche!
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=podcast&limit=10`);
                const data = await res.json();
                
                document.getElementById('search-spinner').style.display = 'none';

                data.results.forEach(pod => {
                    resEl.innerHTML += `
                        <div class="list-item" onclick="playStream('${pod.feedUrl}', '${pod.collectionName.replace(/'/g,"")}', '${pod.artistName.replace(/'/g,"")}', '${pod.artworkUrl600}')">
                            <img src="${pod.artworkUrl100}" class="round">
                            <div class="list-info">
                                <div class="list-title">${pod.collectionName}</div>
                                <div class="list-subtitle">Podcast • ${pod.artistName}</div>
                            </div>
                            <div style="font-size:20px; padding:10px;">+</div>
                        </div>`;
                });
            } catch(e) {
                document.getElementById('search-spinner').innerHTML = 'Fehler bei der Suche.';
            }
        }
    }

    // --- PLAYER LOGIK ---
    function playItem(id) {
        const item = library.find(i => i.id === id);
        if(!item) return;

        if(item.type === 'song') {
            // YouTube
            audioEl.pause();
            if(ytPlayerReady) ytPlayer.loadVideoById(item.id);
            setUIInfo(item.title, item.creator, item.cover, 'song');
        } else {
            // Playlists/Mock
            playMock(item.title);
        }
    }

    // Wenn man einen echten Podcast aus iTunes abspielt
    function playStream(url, title, artist, cover) {
        if(ytPlayerReady) ytPlayer.pauseVideo();
        
        // iTunes API liefert oft keine direkten mp3s im Search, aber wir simulieren es
        // Hier müsste man eigentlich den RSS (feedUrl) parsen. Fürs Feeling spielen wir einen Demo-Ton.
        audioEl.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; 
        audioEl.play();
        setUIInfo(title, artist, cover, 'podcast');
    }

    function playMock(name) {
        setUIInfo(name, "Wird abgespielt...", "https://via.placeholder.com/400/282828/ffffff?text="+name, 'mock');
    }

    function setUIInfo(title, artist, cover, type) {
        currentTrack = { title, artist, type };
        document.getElementById('miniPlayer').style.display = 'flex';
        document.getElementById('mini-title').innerText = title;
        document.getElementById('mini-artist').innerText = artist;
        document.getElementById('mini-img').src = cover;

        document.getElementById('fp-title').innerText = title;
        document.getElementById('fp-artist').innerText = artist;
        document.getElementById('fp-cover').src = cover;
        document.getElementById('fp-bg').style.backgroundImage = `url('${cover}')`;
    }

    function togglePlay(e) {
        e.stopPropagation();
        if(!currentTrack) return;
        
        if(currentTrack.type === 'song' && ytPlayerReady) {
            ytPlayer.getPlayerState() === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
        } else {
            audioEl.paused ? audioEl.play() : audioEl.pause();
        }
    }

    function updatePlayIcons(svg) {
        document.getElementById('mini-play-btn').innerHTML = svg;
        document.getElementById('fp-play-btn').innerHTML = svg;
    }

    function startProgress() {
        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
            let curr = 0, dur = 100;
            if(currentTrack.type === 'song' && ytPlayerReady && ytPlayer.getCurrentTime) {
                curr = ytPlayer.getCurrentTime(); dur = ytPlayer.getDuration();
            } else {
                curr = audioEl.currentTime; dur = audioEl.duration || 100;
            }
            document.getElementById('fp-slider').max = dur;
            document.getElementById('fp-slider').value = curr;
            document.getElementById('fp-time-current').innerText = fmt(curr);
            document.getElementById('fp-time-total').innerText = fmt(dur);
        }, 1000);
    }

    function seekAudio(val) {
        if(currentTrack.type === 'song' && ytPlayerReady) ytPlayer.seekTo(val, true);
        else audioEl.currentTime = val;
    }

    function fmt(sec) {
        if(isNaN(sec)) return "0:00";
        sec = Math.round(sec);
        return Math.floor(sec/60) + ":" + (sec%60 < 10 ? "0" : "") + (sec%60);
    }

    // --- UI NAVIGATION & MENUS ---
    function switchTab(tabId, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function toggleFullScreenPlayer(show) {
        const fp = document.getElementById('fullPlayer');
        show ? fp.classList.add('active') : fp.classList.remove('active');
    }

    function openPlusMenu() {
        document.getElementById('overlayBg').classList.add('active');
        document.getElementById('plusMenu').classList.add('active');
    }

    function closePlusMenu() {
        document.getElementById('overlayBg').classList.remove('active');
        document.getElementById('plusMenu').classList.remove('active');
    }

    function createNewPlaylist() {
        const name = prompt("Name der neuen Playlist:");
        if(name) {
            library.unshift({
                id: Date.now().toString(), type: "playlist", title: name,
                creator: "Du", pinned: false, cover: "https://via.placeholder.com/200/282828/ffffff?text="+name, isGrid: false
            });
            localStorage.setItem('ultimate_lib', JSON.stringify(library));
            renderApp();
            closePlusMenu();
            switchTab('library', document.querySelectorAll('.nav-item')[2]); // Gehe zu Bibliothek
        }
    }

    // INIT
    renderApp();
</script>
</body>
</html>
